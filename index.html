<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>(ì£¼)ì˜ì„ ê¸°ê³„ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ v2.7 (Fixed)</title>
  
  <meta name="theme-color" content="#4A90E2">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2920/2920323.png">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-color: #121212;
      --surface-color: #1e1e1e;
      --border-color: #333;
      --primary-color: #4A90E2;
      --primary-hover: #357ABD;
      --text-color: #e0e0e0;
      --text-muted: #a0a0a0;
      --danger-color: #cf6679;
      --accent-color: #03dac6;
      --success-color: #00e676;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
      margin: 0;
      padding: 20px;
    }

    h2, h3 { margin-top: 0; color: #fff; }

    /* ë ˆì´ì•„ì›ƒ & íƒ­ */
    .container { max-width: 1400px; margin: 0 auto; }
    
    .tab-nav {
      display: flex; gap: 10px; margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color); padding-bottom: 10px; flex-wrap: wrap;
    }
    .tab-btn {
      background: var(--surface-color); border: 1px solid var(--border-color);
      color: var(--text-muted); padding: 10px 20px; cursor: pointer;
      border-radius: 8px; font-weight: bold; transition: all 0.2s;
    }
    .tab-btn:hover { background: #333; color: #fff; }
    .tab-btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }

    .tab-content { display: none; animation: fadeIn 0.3s; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* ì¹´ë“œ & í¼ */
    .card {
      background: var(--surface-color); border-radius: 12px; padding: 20px;
      margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    input[type="text"], input[type="date"], select {
      background: #2c2c2c; border: 1px solid #444; color: #fff;
      padding: 8px 12px; margin: 4px; border-radius: 4px; font-size: 14px;
    }
    input:focus, select:focus { outline: 2px solid var(--primary-color); border-color: transparent; }

    /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ */
    input[type="checkbox"] {
        accent-color: var(--primary-color);
        width: 16px; height: 16px; cursor: pointer;
        vertical-align: middle;
    }
    .status-label {
        display: inline-flex; align-items: center; gap: 5px; 
        margin-right: 8px; cursor: pointer; font-size: 0.9em;
        padding: 2px 6px; border-radius: 4px; transition: background 0.2s;
    }
    .status-label:hover { background: #333; }
    .status-checked { color: var(--success-color); font-weight: bold; }

    button {
      background: #333; color: #fff; border: 1px solid #555;
      padding: 8px 16px; cursor: pointer; border-radius: 4px; transition: background 0.2s;
    }
    button:hover { background: #444; }
    .btn-primary { background: var(--primary-color); border-color: var(--primary-color); }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-danger { background: var(--danger-color); border-color: var(--danger-color); color: #000; }
    
    /* í…Œì´ë¸” */
    .table-container { overflow-x: auto; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; } /* ìˆ˜ì§ ì •ë ¬ ì¤‘ì•™ */
    th { background: #252525; color: var(--text-muted); font-weight: 600; }
    tr:hover { background: #2a2a2a; }

    /* ê¸´ í…ìŠ¤íŠ¸ ë§ì¤„ì„ ì²˜ë¦¬ (ìƒˆë¡œ ì¶”ê°€ë¨) */
    .ellipsis-cell {
        max-width: 180px;      /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
        white-space: nowrap;   /* ì¤„ë°”ê¿ˆ ê¸ˆì§€ */
        overflow: hidden;      /* ë„˜ì¹˜ëŠ” í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
        text-overflow: ellipsis; /* ë§ì¤„ì„í‘œ(...) í‘œì‹œ */
        display: block;        /* ë¸”ë¡ ì†ì„± ë¶€ì—¬í•˜ì—¬ ë„ˆë¹„ ì œí•œ ì ìš© */
        border-bottom: none !important; /* ë‚´ë¶€ display blockìœ¼ë¡œ ì¸í•œ ë³´ë” ê²¹ì¹¨ ë°©ì§€ */
    }
    /* í…Œì´ë¸” ì…€ ë„ˆë¹„ ê°•ì œ ì¡°ì •ì„ ìœ„í•œ ë³´ì¡° ìŠ¤íƒ€ì¼ */
    td:has(.ellipsis-cell) {
        max-width: 180px;
    }

    /* ìœ í‹¸ë¦¬í‹° */
    .flex-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }
    .text-red { color: #ff6b6b; font-weight: bold; }
    .paginator { margin-top: 15px; display: flex; justify-content: center; gap: 4px; }
    .paginator button.active { background: var(--primary-color); border-color: var(--primary-color); }
    .link-text { color: var(--accent-color); text-decoration: underline; cursor: pointer; }

    /* ëª¨ë‹¬ */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.7); backdrop-filter: blur(3px);
      align-items: center; justify-content: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background-color: var(--surface-color); padding: 25px; border-radius: 12px;
      width: 90%; max-width: 800px; max-height: 90vh;
      border: 1px solid #444; display: flex; flex-direction: column; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
    .modal-body { overflow-y: auto; flex-grow: 1; padding-right: 5px; }
    .modal-footer { margin-top: 15px; padding-top: 10px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 10px; }
    .close-modal { font-size: 24px; cursor: pointer; color: #aaa; }
    .close-modal:hover { color: #fff; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { margin-bottom: 5px; color: var(--text-muted); font-size: 0.9em; }
    .form-group input { width: 100%; box-sizing: border-box; margin: 0; }

  </style>
</head>
<body>

<div class="container">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <h2>ğŸ› ï¸ (ì£¼)ì˜ì„ ê¸°ê³„ í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
    <span style="color:var(--text-muted); font-size:0.9em;">Last Updated: <span id="currentDateDisplay"></span></span>
  </div>

  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('schedule')">ğŸ“… ì¼ì •ê´€ë¦¬</button>
    <button class="tab-btn" onclick="switchTab('phonebook')">ğŸ“ ì „í™”ë²ˆí˜¸ë¶€</button>
    <button class="tab-btn" onclick="switchTab('bucket')">ğŸª£ ë²„ì¼“ì£¼ê¸°</button>
    <button class="tab-btn" onclick="switchTab('equipment')">ğŸ“„ ì„¤ë¹„ê´€ë¦¬</button>
    <button class="tab-btn" onclick="switchTab('order')">ğŸ“¦ ë°œì£¼ì •ë³´</button>
  </div>

  <div id="schedule" class="tab-content active">
    <div class="card">
      <h3>ì¼ì • ë“±ë¡</h3>
      <form id="scheduleForm" class="flex-row">
        <input type="date" name="ë‚ ì§œ" required />
        <input type="text" name="ìƒì‚°íŒ€" placeholder="ìƒì‚°íŒ€" required />
        <input type="text" name="ì‘ì—…ë‚´ìš©" placeholder="ì‘ì—…ë‚´ìš©" required />
        <input type="text" name="ë‹´ë‹¹ì" placeholder="ë‹´ë‹¹ì" required />
        <input type="text" name="ë°œì£¼ë²ˆí˜¸" placeholder="ë°œì£¼ë²ˆí˜¸" required />
        <input type="text" name="í•„ìˆ˜ìì¬" placeholder="í•„ìˆ˜ìì¬" />
        <input type="text" name="í—ˆê°€ë²ˆí˜¸" placeholder="í—ˆê°€ë²ˆí˜¸" />
        <input type="text" name="ë¹„ê³ " placeholder="ë¹„ê³ " />
        <button type="submit" class="btn-primary">ì¶”ê°€</button>
      </form>
    </div>
    <div class="card">
      <div class="flex-row" style="justify-content: space-between;">
        <div class="flex-row">
          <input type="text" id="searchBox" placeholder="ğŸ” í†µí•© ê²€ìƒ‰..." style="width: 200px;" />
          <select id="sortKeySel">
            <option value="ë‚ ì§œ">ë‚ ì§œìˆœ</option>
            <option value="ìƒì‚°íŒ€">ìƒì‚°íŒ€ìˆœ</option>
            <option value="ì‘ì—…ë‚´ìš©">ì‘ì—…ë‚´ìš©ìˆœ</option>
          </select>
          <button id="ascBtn">ì˜¤ë¦„ì°¨ìˆœ</button>
          <button id="descBtn">ë‚´ë¦¼ì°¨ìˆœ</button>
        </div>
        <div class="flex-row">
          <input type="date" id="startDate"> ~ <input type="date" id="endDate">
          <button id="filterBtn">ê¸°ê°„ ì¡°íšŒ</button>
          <button id="clearFilterBtn">ì´ˆê¸°í™”</button>
          <button id="summaryBtn" class="btn-primary" style="background:#2d8cf0;">ğŸ“Š ì°¨íŠ¸ ìš”ì•½</button>
        </div>
      </div>
      <div id="chartContainer" style="display:none; margin: 20px 0; height:300px;">
        <canvas id="scheduleChart"></canvas>
      </div>
      <div class="table-container">
        <table id="scheduleTable">
          <thead><tr><th>ë‚ ì§œ</th><th>ìƒì‚°íŒ€</th><th>ì‘ì—…ë‚´ìš©</th><th>ë‹´ë‹¹ì</th><th>ë°œì£¼ë²ˆí˜¸</th><th>í•„ìˆ˜ìì¬</th><th>í—ˆê°€ë²ˆí˜¸</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="pagination" class="paginator"></div>
    </div>
  </div>

  <div id="phonebook" class="tab-content">
    <div class="card">
      <h3>ì—°ë½ì²˜ ë“±ë¡</h3>
      <div class="flex-row">
        <input type="text" id="pbDept" placeholder="ë¶€ì„œ">
        <input type="text" id="pbPosition" placeholder="ì§ì±…">
        <input type="text" id="pbName" placeholder="ì´ë¦„">
        <input type="text" id="pbPhone" placeholder="ì „í™”ë²ˆí˜¸">
        <button onclick="savePhonebook()" class="btn-primary">ì €ì¥</button>
      </div>
    </div>
    <div class="card">
      <input type="text" id="pbSearch" placeholder="ğŸ” ì´ë¦„/ë¶€ì„œ ê²€ìƒ‰" style="width:100%; max-width:300px; margin-bottom:10px;">
      <div class="table-container">
        <table id="pbTable">
          <thead><tr><th>ë¶€ì„œ</th><th>ì§ì±…</th><th>ì´ë¦„</th><th>ì „í™”ë²ˆí˜¸</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="pbPagination" class="paginator"></div>
    </div>
  </div>

  <div id="bucket" class="tab-content">
    <div class="card">
      <h3>ë²„ì¼“ êµì²´ ê¸°ë¡</h3>
      <div class="flex-row">
        <input type="text" id="bkDept" placeholder="ë¶€ì„œ/í˜¸ê¸°">
        <input type="date" id="bkDate">
        <input type="text" id="bkNote" placeholder="ë¹„ê³ ">
        <button onclick="saveBucket()" class="btn-primary">ì €ì¥</button>
      </div>
    </div>
    <div class="card">
      <div class="flex-row">
        <input type="text" id="bkSearch" placeholder="ğŸ” ê²€ìƒ‰">
        <button id="bkAscBtn">ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ</button>
        <button id="bkDescBtn">ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ</button>
      </div>
      <div class="table-container">
        <table id="bkTable">
          <thead><tr><th>ë¶€ì„œ/í˜¸ê¸°</th><th>êµì²´ ë‚ ì§œ</th><th>ê²½ê³¼ ì‹œê°„</th><th>ë¹„ê³ </th><th>ê´€ë¦¬</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="bkPagination" class="paginator"></div>
    </div>
  </div>

  <div id="equipment" class="tab-content">
    <div class="card">
      <h3>ì„¤ë¹„ ìŠ¤í™ ë“±ë¡</h3>
      <div class="flex-row">
        <input type="text" id="esTeam" placeholder="íŒ€ (ì˜ˆ: OF1íŒ€)">
        <input type="text" id="esEqId" placeholder="ì„¤ë¹„ ID (ì˜ˆ: KC-089)">
        <input type="text" id="esLocation" placeholder="ìœ„ì¹˜ (ì˜ˆ: Aë™ 3ì¸µ)">
        <button onclick="openSpecModal('new')" class="btn-primary">ğŸ“ ìŠ¤í™ ìƒì„¸ ì…ë ¥</button>
      </div>
    </div>
    <div class="card">
      <input type="text" id="esSearch" placeholder="ğŸ” íŒ€ / ID / ìœ„ì¹˜ / ìŠ¤í™ ë‚´ìš© ê²€ìƒ‰" style="width:100%; padding:10px;">
      <div class="table-container">
        <table id="esTable">
          <thead><tr><th>íŒ€</th><th>ì„¤ë¹„ ID</th><th>ìœ„ì¹˜</th><th>ì„¸ë¶€ ìŠ¤í™ (ì „ì²´)</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="esPagination" class="paginator"></div>
    </div>
  </div>

  <div id="order" class="tab-content">
    <div class="card">
      <h3>ë°œì£¼ ì •ë³´ ë“±ë¡</h3>
      <div class="flex-row">
        <input type="text" id="odBid" placeholder="ì…ì°°ë²ˆí˜¸">
        <input type="text" id="odReq" placeholder="ì˜ë¢°ë²ˆí˜¸">
        <input type="text" id="odPo" placeholder="êµ¬ë§¤POë²ˆí˜¸">
        <input type="text" id="odRequester" placeholder="ì˜ë¢°ì">
        <input type="text" id="odBuyer" placeholder="êµ¬ë§¤ë‹´ë‹¹ì">
        <input type="text" id="odProject" placeholder="ê³µì‚¬ëª…">
        <input type="text" id="odPermit" placeholder="ì‘ì—…ë‚´ìš©">
        <button onclick="saveOrder()" class="btn-primary">ì €ì¥</button>
      </div>
    </div>
    <div class="card">
      <div class="flex-row">
        <input type="text" id="odSearch" placeholder="ğŸ” POë²ˆí˜¸/ê³µì‚¬ëª… ê²€ìƒ‰">
        <button id="odAscBtn">ìµœì‹ ìˆœ</button>
        <button id="odDescBtn">ì˜¤ë˜ëœìˆœ</button>
      </div>
      <div class="table-container">
        <table id="odTable">
          <thead><tr><th>ì…ì°°ë²ˆí˜¸</th><th>ì˜ë¢°ë²ˆí˜¸</th><th>êµ¬ë§¤POë²ˆí˜¸</th><th>ì˜ë¢°ì</th><th>êµ¬ë§¤ë‹´ë‹¹ì</th><th>ê³µì‚¬ëª…</th><th>ì‘ì—…ë‚´ìš©</th><th>ì§„í–‰ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="odPagination" class="paginator"></div>
    </div>
  </div>

</div>

<div id="scheduleModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>ğŸ“… ì¼ì • ìˆ˜ì •</h3><span class="close-modal" onclick="closeModal('scheduleModal')">&times;</span></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="m_schDate"></div>
        <div class="form-group"><label>ìƒì‚°íŒ€</label><input type="text" id="m_schTeam"></div>
        <div class="form-group"><label>ì‘ì—…ë‚´ìš©</label><input type="text" id="m_schWork"></div>
        <div class="form-group"><label>ë‹´ë‹¹ì</label><input type="text" id="m_schManager"></div>
        <div class="form-group"><label>ë°œì£¼ë²ˆí˜¸</label><input type="text" id="m_schOrderNo"></div>
        <div class="form-group"><label>í•„ìˆ˜ìì¬</label><input type="text" id="m_schMat"></div>
        <div class="form-group"><label>í—ˆê°€ë²ˆí˜¸</label><input type="text" id="m_schPermit"></div>
        <div class="form-group"><label>ë¹„ê³ </label><input type="text" id="m_schNote"></div>
      </div>
    </div>
    <div class="modal-footer"><button onclick="closeModal('scheduleModal')">ì·¨ì†Œ</button><button onclick="saveScheduleFromModal()" class="btn-primary">ìˆ˜ì • ì €ì¥</button></div>
  </div>
</div>

<div id="phoneModal" class="modal">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header"><h3>ğŸ“ ì—°ë½ì²˜ ìˆ˜ì •</h3><span class="close-modal" onclick="closeModal('phoneModal')">&times;</span></div>
    <div class="modal-body">
      <div class="form-grid" style="grid-template-columns: 1fr;">
        <div class="form-group"><label>ë¶€ì„œ</label><input type="text" id="m_pbDept"></div>
        <div class="form-group"><label>ì§ì±…</label><input type="text" id="m_pbPos"></div>
        <div class="form-group"><label>ì´ë¦„</label><input type="text" id="m_pbName"></div>
        <div class="form-group"><label>ì „í™”ë²ˆí˜¸</label><input type="text" id="m_pbPhone"></div>
      </div>
    </div>
    <div class="modal-footer"><button onclick="closeModal('phoneModal')">ì·¨ì†Œ</button><button onclick="savePhoneFromModal()" class="btn-primary">ìˆ˜ì • ì €ì¥</button></div>
  </div>
</div>

<div id="bucketModal" class="modal">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header"><h3>ğŸª£ ë²„ì¼“ ê¸°ë¡ ìˆ˜ì •</h3><span class="close-modal" onclick="closeModal('bucketModal')">&times;</span></div>
    <div class="modal-body">
      <div class="form-grid" style="grid-template-columns: 1fr;">
        <div class="form-group"><label>ë¶€ì„œ/í˜¸ê¸°</label><input type="text" id="m_bkDept"></div>
        <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="m_bkDate"></div>
        <div class="form-group"><label>ë¹„ê³ </label><input type="text" id="m_bkNote"></div>
      </div>
    </div>
    <div class="modal-footer"><button onclick="closeModal('bucketModal')">ì·¨ì†Œ</button><button onclick="saveBucketFromModal()" class="btn-primary">ìˆ˜ì • ì €ì¥</button></div>
  </div>
</div>

<div id="specModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>ğŸ”§ ì„¤ë¹„ ìƒì„¸ ìŠ¤í™ í¸ì§‘</h3><span class="close-modal" onclick="closeModal('specModal')">&times;</span></div>
    <div class="modal-body">
      <div id="modalMetaInfo" style="margin-bottom:15px; color:var(--primary-color); font-weight:bold;"></div>
      <table class="spec-table" id="modalSpecTable" style="width:100%; margin-bottom:15px; border-collapse:collapse;">
        <thead><tr><th style="width:40%">í•­ëª©ëª… (Key)</th><th style="width:40%">ê°’ (Value)</th><th style="width:20%">ì‚­ì œ</th></tr></thead>
        <tbody></tbody>
      </table>
      <button onclick="addModalRow()" style="width:100%; border:1px dashed #555;">+ í•­ëª© ì¶”ê°€</button>
    </div>
    <div class="modal-footer"><button onclick="closeModal('specModal')">ì·¨ì†Œ</button><button onclick="saveSpecFromModal()" class="btn-primary">ì €ì¥ ì™„ë£Œ</button></div>
  </div>
</div>

<div id="orderModal" class="modal">
  <div class="modal-content">
    <div class="modal-header"><h3>ğŸ“¦ ë°œì£¼ ì •ë³´ ìˆ˜ì •</h3><span class="close-modal" onclick="closeModal('orderModal')">&times;</span></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label>ì…ì°°ë²ˆí˜¸</label><input type="text" id="m_odBid"></div>
        <div class="form-group"><label>ì˜ë¢°ë²ˆí˜¸</label><input type="text" id="m_odReq"></div>
        <div class="form-group"><label>êµ¬ë§¤POë²ˆí˜¸</label><input type="text" id="m_odPo"></div>
        <div class="form-group"><label>ì˜ë¢°ì</label><input type="text" id="m_odRequester"></div>
        <div class="form-group"><label>êµ¬ë§¤ë‹´ë‹¹ì</label><input type="text" id="m_odBuyer"></div>
        <div class="form-group"><label>ê³µì‚¬ëª…</label><input type="text" id="m_odProject"></div>
        <div class="form-group"><label>ì‘ì—…ë‚´ìš©</label><input type="text" id="m_odPermit"></div>
        <div class="form-group">
            <label style="color:var(--primary-color); font-weight:bold;">ì§„í–‰ ìƒíƒœ ì²´í¬</label>
            <div style="display:flex; gap:15px; padding:10px; background:#2c2c2c; border-radius:4px;">
                <label><input type="checkbox" id="m_odPermitCheck"> í—ˆê°€ë²ˆí˜¸ ë°œí–‰ë¨</label>
                <label><input type="checkbox" id="m_odDoneCheck"> ì‘ì—… ì™„ë£Œë¨</label>
            </div>
        </div>
      </div>
    </div>
    <div class="modal-footer"><button onclick="closeModal('orderModal')">ì·¨ì†Œ</button><button onclick="saveOrderFromModal()" class="btn-primary">ìˆ˜ì • ì €ì¥</button></div>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwh8AAXw_oWFvM6B0ifjVijLyfmWKmbCmX3yQSSiNlFeFctmMpgIAnE3cfS-GDJocN9iA/exec";
  const getTodayStr = () => { const d = new Date(); const pad = n => n<10 ? '0'+n : n; return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
  const TODAY_DATE_STR = getTodayStr(); document.getElementById('currentDateDisplay').textContent = TODAY_DATE_STR;

  /* --- Utils --- */
  function formatDate(v) {
    if (!v) return "";
    try { const d = new Date(v); if (isNaN(d.getTime())) return v; const pad = n => n<10 ? '0'+n : n; return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; } catch { return v; }
  }

  function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    const buttons = document.querySelectorAll('.tab-btn');
    const idx = ['schedule','phonebook','bucket','equipment','order'].indexOf(tabId);
    if(idx>=0) buttons[idx].classList.add('active');
  }

  function renderPaginator(divId, totalPages, callback, currentPage){
    const div = document.getElementById(divId); div.innerHTML = ""; if(totalPages < 2) return;
    let startP = Math.max(1, currentPage - 2); let endP = Math.min(totalPages, startP + 4);
    for(let i=startP; i<=endP; i++){
      const b = document.createElement("button"); b.textContent = i; if(i === currentPage) b.classList.add("active");
      b.onclick = () => callback(i); div.appendChild(b);
    }
  }

  /* --- Modal Utils --- */
  function openModal(id) { document.getElementById(id).classList.add('show'); }
  function closeModal(id) { document.getElementById(id).classList.remove('show'); }
  let currentSchRow=null, currentPbRow=null, currentBkRow=null, currentOdRow=null;

  /* ================= 1. ì¼ì •ê´€ë¦¬ ================= */
  const schedulePageSize=10, FIELDS=["ë‚ ì§œ","ìƒì‚°íŒ€","ì‘ì—…ë‚´ìš©","ë‹´ë‹¹ì","ë°œì£¼ë²ˆí˜¸","í•„ìˆ˜ìì¬","í—ˆê°€ë²ˆí˜¸","ë¹„ê³ "];
  let schedulePage=1, records=[], searchQuery="", sortKey="ë‚ ì§œ", sortAsc=true, dateFilter={start:null,end:null};
  let scheduleChartInstance = null;

  async function loadSchedule(autoJumpToToday = false){
    try {
        const res = await fetch(API_URL+"?action=schedule_get"); const raw = await res.json();
        records = raw.slice(1).map((row,i) => { const o = {row: i+2}; FIELDS.forEach((k,idx) => o[k] = row[idx]??""); return o; });
        if (autoJumpToToday) {
            const view = getScheduleView(records); let todayIndex = view.findIndex(r => formatDate(r["ë‚ ì§œ"]) === TODAY_DATE_STR);
            if (todayIndex !== -1) schedulePage = Math.floor(todayIndex / schedulePageSize) + 1;
        }
        renderSchedule();
    } catch(e) { console.error(e); alert("ì¼ì • ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); }
  }

  function getScheduleView(data = records){
    let view = data.filter(r => {
      if(searchQuery){ const hay = FIELDS.map(k=>r[k]??"").join(" ").toLowerCase(); if(!hay.includes(searchQuery.toLowerCase())) return false; }
      if(dateFilter.start || dateFilter.end){ const dStr = formatDate(r["ë‚ ì§œ"]); if(!dStr) return false; if(dateFilter.start && dStr < dateFilter.start) return false; if(dateFilter.end && dStr > dateFilter.end) return false; }
      return true;
    });
    view.sort((a,b)=>{
      let A=a[sortKey]??"", B=b[sortKey]??"";
      if(sortKey==="ë‚ ì§œ"){ const da=formatDate(A), db=formatDate(B); return sortAsc ? da.localeCompare(db) : db.localeCompare(da); }
      return sortAsc ? String(A).localeCompare(String(B),"ko",{numeric:true,sensitivity:"base"}) : String(B).localeCompare(String(A),"ko",{numeric:true,sensitivity:"base"});
    });
    return view;
  }

  function renderSchedule(){
    const view = getScheduleView(); const totalPages = Math.ceil(view.length/schedulePageSize)||1; if(schedulePage > totalPages) schedulePage=1;
    const start = (schedulePage-1)*schedulePageSize; const end = start + schedulePageSize;
    const tb = document.querySelector("#scheduleTable tbody"); tb.innerHTML = "";
    view.slice(start,end).forEach(r => {
      const tr = document.createElement("tr");
      FIELDS.forEach(k => {
        const td = document.createElement("td"); let val = (k==="ë‚ ì§œ" ? formatDate(r[k]) : r[k]);
        if(k==="ë‚ ì§œ" && val===TODAY_DATE_STR) { td.classList.add("text-red"); td.textContent = val; } 
        else if (k === "ë°œì£¼ë²ˆí˜¸" && val) { td.innerHTML = `<span class="link-text" onclick="searchOrderByPO('${val}')">${val}</span>`; } 
        else { td.textContent = val; }
        tr.appendChild(td);
      });
      tr.innerHTML += `<td><button onclick="openScheduleModal(${r.row})">âœï¸</button> <button onclick="deleteRecord(${r.row})" class="btn-danger">ğŸ—‘ï¸</button></td>`;
      tb.appendChild(tr);
    });
    renderPaginator("pagination", totalPages, (p)=>{schedulePage=p;renderSchedule();}, schedulePage);
  }
  
  // (ìˆ˜ì •) ì¼ì •ê´€ë¦¬ì—ì„œ ë°œì£¼ ê²€ìƒ‰
  function searchOrderByPO(po){ if(!po) return; switchTab('order'); document.getElementById('odSearch').value = po; document.getElementById('odSearch').dispatchEvent(new Event('input')); }
  
  // (ì‹ ê·œ ì¶”ê°€) ë°œì£¼ì •ë³´ì—ì„œ ì¼ì •ê´€ë¦¬ ê²€ìƒ‰ (ì–‘ë°©í–¥ ë§í¬ ê¸°ëŠ¥)
  function searchScheduleByPO(po){
      if(!po) return;
      switchTab('schedule'); // ì¼ì •ê´€ë¦¬ íƒ­ìœ¼ë¡œ ì´ë™
      document.getElementById('searchBox').value = po; // ê²€ìƒ‰ì°½ì— PO ì…ë ¥
      document.getElementById('searchBox').dispatchEvent(new Event('input')); // ê²€ìƒ‰ ì´ë²¤íŠ¸ ì‹¤í–‰
  }

  function openScheduleModal(row){
      currentSchRow = row; const rec = records.find(r => r.row === row); if(!rec) return;
      document.getElementById('m_schDate').value = formatDate(rec["ë‚ ì§œ"]); document.getElementById('m_schTeam').value = rec["ìƒì‚°íŒ€"];
      document.getElementById('m_schWork').value = rec["ì‘ì—…ë‚´ìš©"]; document.getElementById('m_schManager').value = rec["ë‹´ë‹¹ì"];
      document.getElementById('m_schOrderNo').value = rec["ë°œì£¼ë²ˆí˜¸"]; document.getElementById('m_schMat').value = rec["í•„ìˆ˜ìì¬"];
      document.getElementById('m_schPermit').value = rec["í—ˆê°€ë²ˆí˜¸"]; document.getElementById('m_schNote').value = rec["ë¹„ê³ "];
      openModal('scheduleModal');
  }
  async function saveScheduleFromModal(){
      const date=document.getElementById('m_schDate').value, team=document.getElementById('m_schTeam').value, work=document.getElementById('m_schWork').value;
      const manager=document.getElementById('m_schManager').value, orderNo=document.getElementById('m_schOrderNo').value;
      const mat=document.getElementById('m_schMat').value, permit=document.getElementById('m_schPermit').value, note=document.getElementById('m_schNote').value;
      await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"update", row: currentSchRow, "ë‚ ì§œ": date, "ìƒì‚°íŒ€": team, "ì‘ì—…ë‚´ìš©": work, "ë‹´ë‹¹ì": manager, "ë°œì£¼ë²ˆí˜¸": orderNo, "í•„ìˆ˜ìì¬": mat, "í—ˆê°€ë²ˆí˜¸": permit, "ë¹„ê³ ": note})});
      closeModal('scheduleModal'); loadSchedule();
  }
  document.getElementById("scheduleForm").addEventListener("submit", async e => {
    e.preventDefault(); const fd = new FormData(e.target); const payload = {action:"add"}; FIELDS.forEach(k => payload[k] = fd.get(k)||"");
    await fetch(API_URL, {method:"POST", body:JSON.stringify(payload)}); e.target.reset(); loadSchedule();
  });
  async function deleteRecord(row){ if(confirm("ì‚­ì œ?")) { await fetch(API_URL, {method:"POST", body:JSON.stringify({action:"delete", row})}); loadSchedule(); } }
  document.getElementById("searchBox").addEventListener("input",e=>{searchQuery=e.target.value; schedulePage=1; renderSchedule();});
  document.getElementById("sortKeySel").addEventListener("change",e=>{sortKey=e.target.value; renderSchedule();});
  document.getElementById("ascBtn").addEventListener("click",()=>{sortAsc=true; schedulePage=1; renderSchedule();});
  document.getElementById("descBtn").addEventListener("click",()=>{sortAsc=false; schedulePage=1; renderSchedule();});
  document.getElementById("summaryBtn").addEventListener("click", () => {
    const container = document.getElementById("chartContainer"); if(container.style.display === "block"){ container.style.display="none"; return; }
    container.style.display = "block"; const view = getScheduleView(); const byMonth = {};
    view.forEach(r => { const d = formatDate(r["ë‚ ì§œ"]); if(d) byMonth[d.slice(0,7)] = (byMonth[d.slice(0,7)]||0) + 1; });
    const labels = Object.keys(byMonth).sort(); const data = labels.map(k => byMonth[k]);
    const ctx = document.getElementById('scheduleChart').getContext('2d'); if(scheduleChartInstance) scheduleChartInstance.destroy();
    scheduleChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'ì‘ì—… ê±´ìˆ˜', data, backgroundColor: 'rgba(74, 144, 226, 0.6)' }] }, options: { maintainAspectRatio:false, scales:{y:{beginAtZero:true}} } });
  });

  /* ================= 2. ì „í™”ë²ˆí˜¸ë¶€ & 3. ë²„ì¼“ì£¼ê¸° & 4. ì„¤ë¹„ê´€ë¦¬ ================= */
  let pbPage=1, pageSizePhone=10, pbRowMap=new Map();
  async function loadPhonebook(){
    const res = await fetch(API_URL+"?action=phone_get"); const rows = await res.json();
    pbRowMap.clear(); const all = rows.slice(1).map((r,i)=>({row:i+2, cells:r})); all.forEach(it=>pbRowMap.set(it.row,it.cells));
    const kw = (document.getElementById('pbSearch').value||"").toLowerCase();
    const filtered = all.filter(it=>it.cells.join(" ").toLowerCase().includes(kw));
    const totalPages = Math.ceil(filtered.length/pageSizePhone)||1; if(pbPage>totalPages) pbPage=1;
    const start=(pbPage-1)*pageSizePhone, end=start+pageSizePhone;
    const tb = document.querySelector("#pbTable tbody"); tb.innerHTML="";
    filtered.slice(start,end).forEach(it=>{
      const r = it.cells, tr = document.createElement("tr");
      tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td><button onclick='openPhoneModal(${it.row})'>âœï¸</button> <button onclick='deletePhone(${it.row})' class="btn-danger">ğŸ—‘ï¸</button></td>`;
      tb.appendChild(tr);
    });
    renderPaginator("pbPagination",totalPages,(p)=>{pbPage=p;loadPhonebook();},pbPage);
  }
  function openPhoneModal(row){ currentPbRow = row; const old = pbRowMap.get(row)||["","","",""]; document.getElementById('m_pbDept').value = old[0]; document.getElementById('m_pbPos').value = old[1]; document.getElementById('m_pbName').value = old[2]; document.getElementById('m_pbPhone').value = old[3]; openModal('phoneModal'); }
  async function savePhoneFromModal(){ const dept=document.getElementById('m_pbDept').value, pos=document.getElementById('m_pbPos').value, name=document.getElementById('m_pbName').value, phone=document.getElementById('m_pbPhone').value; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"phone_update",row:currentPbRow, dept,position:pos,name,phone})}); closeModal('phoneModal'); loadPhonebook(); }
  async function savePhonebook(){ const dept=document.getElementById('pbDept').value, pos=document.getElementById('pbPosition').value, name=document.getElementById('pbName').value, phone=document.getElementById('pbPhone').value; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"phone_add",dept,position:pos,name,phone})}); document.getElementById('pbDept').value=""; document.getElementById('pbPosition').value=""; document.getElementById('pbName').value=""; document.getElementById('pbPhone').value=""; loadPhonebook(); }
  async function deletePhone(row){ if(confirm("ì‚­ì œ?")){ await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"phone_delete",row})}); loadPhonebook(); } }
  document.getElementById("pbSearch").addEventListener("input",()=>{pbPage=1;loadPhonebook();});

  let bkPage=1, pageSizeBucket=10, bkRowMap=new Map(), bkSortAsc=false;
  function getElapsedTime(dateStr) { const target = new Date(dateStr); const now = new Date(); if(isNaN(target)) return "-"; const diffDays = Math.ceil(Math.abs(now - target) / (1000 * 60 * 60 * 24)); return diffDays < 30 ? `${diffDays}ì¼ ì „` : `${Math.floor(diffDays/30)}ê°œì›” ì „`; }
  async function loadBucket(){
    const res = await fetch(API_URL+"?action=bucket_get"); const rows = await res.json();
    bkRowMap.clear(); const all = rows.slice(1).map((r,i)=>({row:i+2, cells:r})); all.forEach(it=>bkRowMap.set(it.row,it.cells));
    const kw = (document.getElementById('bkSearch').value||"").toLowerCase();
    let filtered = all.filter(it=>it.cells.join(" ").toLowerCase().includes(kw));
    filtered.sort((a,b)=>{ const da=new Date(a.cells[1]), db=new Date(b.cells[1]); return !isNaN(da)&&!isNaN(db) ? (bkSortAsc?da-db:db-da) : 0; });
    const totalPages = Math.ceil(filtered.length/pageSizeBucket)||1; if(bkPage>totalPages) bkPage=1;
    const start=(bkPage-1)*pageSizeBucket, end=start+pageSizeBucket;
    const tb = document.querySelector("#bkTable tbody"); tb.innerHTML="";
    filtered.slice(start,end).forEach(it=>{
      const r = it.cells, tr = document.createElement("tr");
      tr.innerHTML=`<td>${r[0]}</td><td>${formatDate(r[1])}</td><td style="color:var(--accent-color)">${getElapsedTime(r[1])}</td><td>${r[2]}</td><td><button onclick='openBucketModal(${it.row})'>âœï¸</button> <button onclick='deleteBucket(${it.row})' class="btn-danger">ğŸ—‘ï¸</button></td>`;
      tb.appendChild(tr);
    });
    renderPaginator("bkPagination",totalPages,(p)=>{bkPage=p;loadBucket();},bkPage);
  }
  function openBucketModal(row){ currentBkRow = row; const old = bkRowMap.get(row)||["","",""]; document.getElementById('m_bkDept').value = old[0]; document.getElementById('m_bkDate').value = formatDate(old[1]); document.getElementById('m_bkNote').value = old[2]; openModal('bucketModal'); }
  async function saveBucketFromModal(){ const dept=document.getElementById('m_bkDept').value, date=document.getElementById('m_bkDate').value, note=document.getElementById('m_bkNote').value; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"bucket_update",row:currentBkRow, dept,date,note})}); closeModal('bucketModal'); loadBucket(); }
  async function saveBucket(){ const dept=document.getElementById('bkDept').value, date=document.getElementById('bkDate').value, note=document.getElementById('bkNote').value; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"bucket_add",dept,date,note})}); document.getElementById('bkDept').value=""; document.getElementById('bkDate').value=""; document.getElementById('bkNote').value=""; loadBucket(); }
  async function deleteBucket(row){ if(confirm("ì‚­ì œ?")){ await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"bucket_delete",row})}); loadBucket(); } }
  document.getElementById("bkSearch").addEventListener("input",()=>{bkPage=1;loadBucket();});
  document.getElementById("bkAscBtn").addEventListener("click",()=>{ bkSortAsc=true; bkPage=1; loadBucket(); });
  document.getElementById("bkDescBtn").addEventListener("click",()=>{ bkSortAsc=false; bkPage=1; loadBucket(); });

  let esPage=1, pageSizeSpec=5, esRowMap=new Map(), currentSpecRow = null; 
  const defaultSpecs = ["í¬ë ˆì¸ ì¢…ë¥˜", "ì–‘ì •", "ì •ê²© ì†ë„", "ëª¨í„°", "ê°ì†ê¸°", "ë ˆì¼", "ì™€ì´ì–´ë¡œí”„"];
  async function loadEquipmentSpec(){
    const res = await fetch(API_URL+"?action=spec_get"); const rows = await res.json();
    esRowMap.clear(); const all = rows.slice(1).map((r,i)=>({row:i+2, cells:r})); all.forEach(it=>esRowMap.set(it.row,it.cells));
    const kw = (document.getElementById('esSearch').value||"").toLowerCase(); const tb = document.querySelector("#esTable tbody");
    if(kw.length === 0) { tb.innerHTML = "<tr><td colspan='5' style='text-align:center;'>ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ë©´ ì„¤ë¹„ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</td></tr>"; document.getElementById("esPagination").innerHTML=""; return; }
    let filtered = all.filter(it=>it.cells.join(" ").toLowerCase().includes(kw));
    const totalPages = Math.ceil(filtered.length/pageSizeSpec)||1; if(esPage>totalPages) esPage=1;
    const start=(esPage-1)*pageSizeSpec, end=start+pageSizeSpec;
    tb.innerHTML="";
    filtered.slice(start,end).forEach(it=>{
      const r=it.cells, tr=document.createElement("tr");
      let specDisplay = "ì—†ìŒ";
      try { const parsed = JSON.parse(r[3]); if(Object.keys(parsed).length > 0) specDisplay = Object.entries(parsed).map(([k,v]) => `<div style="padding:1px 0;"><b>${k}</b>: ${v}</div>`).join(""); } catch {}
      tr.innerHTML=`<td>${r[0]}</td><td style="font-weight:bold; color:var(--primary-color);">${r[1]}</td><td>${r[2]||'-'}</td><td style="font-size:0.9em; color:#ccc; line-height:1.4;">${specDisplay}</td><td><button onclick='openSpecModal("edit", ${it.row})'>ğŸ“ ìƒì„¸/ìˆ˜ì •</button> <button onclick='deleteEquipmentSpec(${it.row})' class="btn-danger">ğŸ—‘ï¸</button></td>`;
      tb.appendChild(tr);
    });
    renderPaginator("esPagination",totalPages,(p)=>{esPage=p;loadEquipmentSpec();},esPage);
  }
  function openSpecModal(mode, row = null) {
      const tbody = document.querySelector("#modalSpecTable tbody"); tbody.innerHTML = ""; const metaInfo = document.getElementById("modalMetaInfo");
      if (mode === 'new') { const team=document.getElementById('esTeam').value, id=document.getElementById('esEqId').value, loc=document.getElementById('esLocation').value; if(!team || !id) { alert("íŒ€ê³¼ ID í•„ìš”"); return; } currentSpecRow=null; metaInfo.textContent=`ì‹ ê·œ: [${team}] ${id}`; defaultSpecs.forEach(k => addModalRow(k, "")); } 
      else { currentSpecRow = row; const data = esRowMap.get(row); metaInfo.textContent = `ìˆ˜ì •: [${data[0]}] ${data[1]}`; try { const json = JSON.parse(data[3]); Object.entries(json).forEach(([k,v])=>addModalRow(k,v)); } catch { defaultSpecs.forEach(k => addModalRow(k, "")); } }
      openModal('specModal');
  }
  function addModalRow(key="", value="") { const tbody = document.querySelector("#modalSpecTable tbody"); const tr = document.createElement("tr"); tr.innerHTML = `<td><input type="text" value="${key}" style="width:95%"></td><td><input type="text" value="${value}" style="width:95%"></td><td style="text-align:center;"><button onclick="this.closest('tr').remove()" class="btn-danger">x</button></td>`; tbody.appendChild(tr); }
  async function saveSpecFromModal() {
      const rows = document.querySelectorAll("#modalSpecTable tbody tr"); const newSpec = {}; rows.forEach(tr => { const inputs = tr.querySelectorAll("input"); if(inputs[0].value) newSpec[inputs[0].value] = inputs[1].value; }); const specStr = JSON.stringify(newSpec);
      if (currentSpecRow === null) { const team=document.getElementById('esTeam').value, eqId=document.getElementById('esEqId').value, location=document.getElementById('esLocation').value; await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"spec_add", team, eqId, location, spec: specStr})}); document.getElementById('esTeam').value=""; document.getElementById('esEqId').value=""; document.getElementById('esLocation').value=""; } 
      else { const old = esRowMap.get(currentSpecRow); await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"spec_update", row: currentSpecRow, team: old[0], eqId: old[1], location: old[2], spec: specStr})}); }
      closeModal('specModal'); alert("ì €ì¥ë¨"); loadEquipmentSpec();
  }
  async function deleteEquipmentSpec(row){ if(confirm("ì‚­ì œ?")) { await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"spec_delete",row})}); loadEquipmentSpec(); } }
  document.getElementById("esSearch").addEventListener("input",()=>{esPage=1;loadEquipmentSpec();});

  /* ================= 5. ë°œì£¼ì •ë³´ ================= */
  let odPage=1, pageSizeOrder=10, odRowMap=new Map(), odSortAsc=false;
  
  async function loadOrder(){
    const res = await fetch(API_URL+"?action=order_get"); const rows = await res.json();
    odRowMap.clear(); const all = rows.slice(1).map((r,i)=>({row:i+2, cells:r})); all.forEach(it=>odRowMap.set(it.row,it.cells));
    const kw = (document.getElementById('odSearch').value||"").toLowerCase();
    const filtered = all.filter(it=>it.cells.join(" ").toLowerCase().includes(kw));
    filtered.sort((a,b)=>odSortAsc ? a.row-b.row : b.row-a.row);
    
    const totalPages = Math.ceil(filtered.length/pageSizeOrder)||1; if(odPage>totalPages) odPage=1;
    const start=(odPage-1)*pageSizeOrder, end=start+pageSizeOrder;
    const tb = document.querySelector("#odTable tbody"); tb.innerHTML="";
    
    filtered.slice(start,end).forEach(it=>{
      const r=it.cells, tr=document.createElement("tr");
      // Tì—´ì€ index 19 (0ë¶€í„° ì‹œì‘: A=0 ... T=19)
      let status = { permit: false, done: false };
      try { if(r[19]) status = JSON.parse(r[19]); } catch(e){}

      // [ë³€ê²½ì  1] ê³µì‚¬ëª…(r[5])ê³¼ ì‘ì—…ë‚´ìš©(r[6])ì— ellipsis-cell í´ë˜ìŠ¤ ì¶”ê°€ ë° íˆ´íŒ(title) ì¶”ê°€
      // [ë³€ê²½ì  2] POë²ˆí˜¸(r[2])ì— searchScheduleByPO ë§í¬ ì—°ê²°
      tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td>
                    <td><span class="link-text" onclick="searchScheduleByPO('${r[2]}')">${r[2]}</span></td>
                    <td>${r[3]}</td><td>${r[4]}</td>
                    <td><span class="ellipsis-cell" title="${r[5]}">${r[5]}</span></td>
                    <td><span class="ellipsis-cell" title="${r[6]}">${r[6]}</span></td>
                    <td>
                        <label class="status-label ${status.permit?'status-checked':''}"><input type="checkbox" onchange="updateOrderStatus(${it.row}, 'permit', this.checked)" ${status.permit?'checked':''}> í—ˆê°€ë°œí–‰</label><br>
                        <label class="status-label ${status.done?'status-checked':''}"><input type="checkbox" onchange="updateOrderStatus(${it.row}, 'done', this.checked)" ${status.done?'checked':''}> ì‘ì—…ì™„ë£Œ</label>
                    </td>
                    <td><button onclick='openOrderModal(${it.row})'>âœï¸</button> <button onclick='deleteOrder(${it.row})' class="btn-danger">ğŸ—‘ï¸</button></td>`;
      tb.appendChild(tr);
    });
    renderPaginator("odPagination",totalPages,(p)=>{odPage=p;loadOrder();},odPage);
  }

  async function updateOrderStatus(row, key, checked) {
      const oldCells = odRowMap.get(row);
      if(!oldCells) return;
      
      let status = { permit: false, done: false };
      // Tì—´(index 19) ë°ì´í„° íŒŒì‹±
      try { if(oldCells[19]) status = JSON.parse(oldCells[19]); } catch(e){}
      
      // 1. ë¡œì»¬ ë°ì´í„° ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (í™”ë©´ ê¹œë¹¡ì„ ë°©ì§€)
      status[key] = checked;
      const jsonStr = JSON.stringify(status);
      oldCells[19] = jsonStr; 

      // 2. ì„œë²„ë¡œ ë¹„ë™ê¸° ì „ì†¡ (ì‚¬ìš©ìëŠ” ê¸°ë‹¤ë¦´ í•„ìš” ì—†ìŒ)
      try {
          await fetch(API_URL, {
              method: "POST",
              body: JSON.stringify({
                  action: "order_update", 
                  row: row,
                  bid: oldCells[0], req: oldCells[1], po: oldCells[2],
                  requester: oldCells[3], buyer: oldCells[4], project: oldCells[5], permit: oldCells[6],
                  note: jsonStr 
              })
          });
      } catch (error) {
          console.error("ì €ì¥ ì‹¤íŒ¨", error);
          alert("ì„œë²„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
          loadOrder(); 
      }
  }

  function openOrderModal(row){
      currentOdRow = row; const old = odRowMap.get(row)||["","","","","","",""];
      document.getElementById('m_odBid').value = old[0]; document.getElementById('m_odReq').value = old[1];
      document.getElementById('m_odPo').value = old[2]; document.getElementById('m_odRequester').value = old[3];
      document.getElementById('m_odBuyer').value = old[4]; document.getElementById('m_odProject').value = old[5];
      document.getElementById('m_odPermit').value = old[6]; 
      
      // Modal Read T (19)
      let status = { permit: false, done: false };
      try { if(old[19]) status = JSON.parse(old[19]); } catch{}
      document.getElementById('m_odPermitCheck').checked = status.permit;
      document.getElementById('m_odDoneCheck').checked = status.done;
      
      openModal('orderModal');
  }

  async function saveOrderFromModal(){
      const bid=document.getElementById('m_odBid').value, req=document.getElementById('m_odReq').value;
      const po=document.getElementById('m_odPo').value, requester=document.getElementById('m_odRequester').value;
      const buyer=document.getElementById('m_odBuyer').value, project=document.getElementById('m_odProject').value;
      const permit=document.getElementById('m_odPermit').value;
      
      const status = {
          permit: document.getElementById('m_odPermitCheck').checked,
          done: document.getElementById('m_odDoneCheck').checked
      };

      await fetch(API_URL,{method:"POST",body:JSON.stringify({
          action:"order_update", row: currentOdRow, 
          bid, req, po, requester, buyer, project, permit,
          note: JSON.stringify(status)
      })});
      closeModal('orderModal'); loadOrder();
  }

  async function saveOrder(){
      const bid=document.getElementById('odBid').value, req=document.getElementById('odReq').value;
      const po=document.getElementById('odPo').value, requester=document.getElementById('odRequester').value;
      const buyer=document.getElementById('odBuyer').value, project=document.getElementById('odProject').value;
      const permit=document.getElementById('odPermit').value;
      
      const defaultStatus = JSON.stringify({ permit: false, done: false });

      await fetch(API_URL,{method:"POST",body:JSON.stringify({
          action:"order_add", bid, req, po, requester, buyer, project, permit,
          note: defaultStatus
      })});
      
      [odBid,odReq,odPo,odRequester,odBuyer,odProject,odPermit].forEach(el=>el.value="");
      loadOrder();
  }

  async function deleteOrder(row){ if(confirm("ì‚­ì œ?")){ await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"order_delete",row})}); loadOrder(); } }
  document.getElementById("odSearch").addEventListener("input",()=>{odPage=1;loadOrder();});
  document.getElementById("odAscBtn").addEventListener("click",()=>{ odSortAsc=true; odPage=1; loadOrder(); });
  document.getElementById("odDescBtn").addEventListener("click",()=>{ odSortAsc=false; odPage=1; loadOrder(); });

  /* Init */
  loadSchedule(true); loadPhonebook(); loadBucket(); loadOrder(); loadEquipmentSpec();
</script>
</body>
</html>